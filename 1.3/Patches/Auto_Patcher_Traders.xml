<?xml version="1.0" encoding="utf-8"?>
<Patch>

  <Operation Class="XmlExtensions.OptionalPatch">
    <modId>EverybodyBuysSlaves</modId>
    <key>Exclude_Visitors</key>
    <defaultValue>false</defaultValue>
    <caseTrue>

      <Operation Class="XmlExtensions.ForEach">
        <xpath>Defs/TraderKindDef[not(defName="Guest")]</xpath> 
        <storeIn>TraderKindDef_Path</storeIn>
        <apply> 
          <Operation Class="XmlExtensions.IfStatement">
            <condition Class="XmlExtensions.Boolean.Comparison">
              <value1>Defs/FactionDef/visitorTraderKinds/li</value1>
              <value2>{TraderKindDef_Path}/defName</value2>
              <fromXml1>true</fromXml1>
              <fromXml2>true</fromXml2>
              <nonNumeric>true</nonNumeric>
              <logic>or</logic>
            </condition>
            <caseFalse> 
              <Operation Class="PatchOperationConditional">
                <xpath>{TraderKindDef_Path}/stockGenerators/li[@Class="StockGenerator_Slaves" or @Class="StockGenerator_BuySlaves"]</xpath>
                <nomatch Class="PatchOperationAdd">
                  <xpath>{TraderKindDef_Path}/stockGenerators</xpath>
                  <value>
                    <li Class="StockGenerator_BuySlaves" />
                  </value>
                </nomatch>
              </Operation>
            </caseFalse>
          </Operation>
        </apply>
      </Operation>

    </caseTrue>
    <caseFalse>

      <Operation Class="XmlExtensions.ForEach">
        <xpath>Defs/TraderKindDef[not(defName="Guest")]</xpath> 
        <storeIn>TraderKindDef_Path</storeIn>
        <apply> 
          <Operation Class="PatchOperationConditional">
            <xpath>{TraderKindDef_Path}/stockGenerators/li[@Class="StockGenerator_Slaves" or @Class="StockGenerator_BuySlaves"]</xpath>
            <nomatch Class="PatchOperationAdd">
              <xpath>{TraderKindDef_Path}/stockGenerators</xpath>
              <value>
                <li Class="StockGenerator_BuySlaves" />
              </value>
            </nomatch>
          </Operation>
        </apply>
      </Operation>
  
    </caseFalse>
  </Operation>

</Patch>